<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qmob - Gerador de Laudo v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #0f172a; --accent: #6366f1; --text: #1e293b;
            --text-light: #64748b; --bg: #f8fafc; --card: #ffffff;
            --border: #e2e8f0; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        
        .control-panel {
            background: var(--primary); color: white; padding: 20px;
            position: sticky; top: 0; z-index: 100;
        }
        .control-header {
            display: flex; align-items: center; justify-content: space-between;
            max-width: 900px; margin: 0 auto;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-box {
            width: 36px; height: 36px; background: var(--accent); border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.25rem;
        }
        .logo-text { font-size: 1.25rem; font-weight: 700; }
        .control-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn {
            padding: 10px 20px; border-radius: 8px; font-size: 0.875rem;
            font-weight: 600; font-family: inherit; cursor: pointer; border: none; transition: all 0.2s;
        }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; }
        .btn-outline:hover { background: rgba(255,255,255,0.1); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #5855eb; }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; }
        .btn-ai:hover { opacity: 0.9; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--card); border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal h3 { font-size: 1.125rem; margin-bottom: 16px; }
        .modal-input { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 0.875rem; margin-bottom: 12px; }
        .modal-input:focus { outline: none; border-color: var(--accent); }
        .modal-actions { display: flex; gap: 12px; margin-top: 16px; }
        .modal-actions .btn { flex: 1; }
        
        /* AI Analysis */
        .ai-analysis { background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border: 1px solid #c4b5fd; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .ai-analysis h4 { color: #6d28d9; font-size: 1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .ai-analysis .loading { text-align: center; padding: 20px; color: var(--text-light); }
        .ai-content { font-size: 0.875rem; line-height: 1.7; }
        .ai-content h5 { font-size: 0.9375rem; color: #6d28d9; margin: 16px 0 8px; }
        .ai-content ul { margin-left: 20px; }
        .ai-content li { margin-bottom: 4px; }

        .tabs-bar { background: var(--card); border-bottom: 1px solid var(--border); padding: 0 20px; }
        .tabs-inner { max-width: 900px; margin: 0 auto; display: flex; gap: 0; }
        .tab-btn {
            padding: 16px 24px; font-size: 0.9375rem; font-weight: 600;
            color: var(--text-light); background: none; border: none; cursor: pointer;
            border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

        .content { max-width: 900px; margin: 0 auto; padding: 30px 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .no-data {
            text-align: center; padding: 60px 20px; background: var(--card);
            border-radius: 16px; border: 2px dashed var(--border);
        }
        .no-data h2 { font-size: 1.5rem; margin-bottom: 10px; }
        .no-data p { color: var(--text-light); margin-bottom: 20px; }

        /* LAUDO */
        .laudo { background: var(--card); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .laudo-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1e293b 100%);
            color: white; padding: 40px; display: grid; grid-template-columns: 1fr auto; gap: 30px; align-items: center;
        }
        .laudo-title { font-family: 'Fraunces', serif; font-size: 1.75rem; font-weight: 700; margin-bottom: 6px; }
        .laudo-subtitle { font-size: 1rem; opacity: 0.8; }
        .laudo-meta { font-size: 0.8125rem; opacity: 0.6; margin-top: 10px; }
        .score-circle {
            width: 130px; height: 130px; border-radius: 50%; background: rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 4px solid rgba(255,255,255,0.3);
        }
        .score-circle .number { font-family: 'Fraunces', serif; font-size: 3rem; font-weight: 700; line-height: 1; }
        .score-circle .label { font-size: 0.6875rem; opacity: 0.7; margin-top: 2px; }
        .score-circle .badge {
            font-size: 0.625rem; font-weight: 600; padding: 3px 10px;
            background: rgba(255,255,255,0.2); border-radius: 100px; margin-top: 6px;
        }
        .laudo-body { padding: 40px; }
        .laudo-section { margin-bottom: 36px; }
        .laudo-section:last-child { margin-bottom: 0; }
        .section-title {
            font-size: 1.125rem; font-weight: 700; color: var(--primary);
            margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border);
            display: flex; align-items: center; gap: 8px;
        }

        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .data-item { background: var(--bg); padding: 14px; border-radius: 10px; }
        .data-item .label {
            font-size: 0.6875rem; font-weight: 600; color: var(--text-light);
            text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 2px;
        }
        .data-item .value { font-size: 1rem; font-weight: 600; color: var(--text); }

        /* Indicadores com cores */
        .data-item.green { background: #dcfce7; }
        .data-item.green .value { color: #166534; }
        .data-item.yellow { background: #fef3c7; }
        .data-item.yellow .value { color: #92400e; }
        .data-item.red { background: #fee2e2; }
        .data-item.red .value { color: #991b1b; }

        .dimension-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        @media (max-width: 700px) { .dimension-grid { grid-template-columns: 1fr; } }
        .dimension-card { background: var(--bg); border-radius: 12px; padding: 18px; }
        .dimension-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .dimension-name { font-size: 0.9375rem; font-weight: 600; }
        .dimension-score { font-size: 1.25rem; font-weight: 700; }
        .dimension-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 12px; }
        .dimension-fill { height: 100%; border-radius: 3px; }
        .dimension-criteria { display: flex; flex-direction: column; gap: 6px; }
        .criteria-item { display: flex; justify-content: space-between; font-size: 0.75rem; }
        .criteria-name { color: var(--text-light); }
        .criteria-value { font-weight: 600; }

        .checklist-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; }
        .check-display {
            display: flex; align-items: center; gap: 8px; padding: 10px 12px;
            background: var(--bg); border-radius: 8px; font-size: 0.8125rem;
        }
        .check-display.yes { background: #dcfce7; color: #166534; }
        .check-display.no { background: #fee2e2; color: #991b1b; }

        .solar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        .solar-item { background: var(--bg); padding: 12px; border-radius: 8px; text-align: center; }
        .solar-item .room { font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px; }
        .solar-item .dir { font-size: 1rem; font-weight: 700; color: var(--text); }
        .solar-item .meaning { font-size: 0.6875rem; color: var(--text-light); margin-top: 2px; }

        .positioning-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd; border-radius: 12px; padding: 20px; margin-top: 16px;
        }
        .positioning-box h4 { font-size: 0.9375rem; font-weight: 600; color: #0369a1; margin-bottom: 12px; }
        .positioning-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        @media (max-width: 600px) { .positioning-grid { grid-template-columns: 1fr; } }
        .positioning-item { background: white; padding: 12px; border-radius: 8px; }
        .positioning-item .label { font-size: 0.6875rem; color: #64748b; text-transform: uppercase; }
        .positioning-item .value { font-size: 0.875rem; font-weight: 600; color: #0c4a6e; margin-top: 4px; }

        .obs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 600px) { .obs-grid { grid-template-columns: 1fr; } }
        .obs-box { padding: 18px; border-radius: 12px; }
        .obs-box.positivo { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .obs-box.atencao { background: #fefce8; border: 1px solid #fef08a; }
        .obs-box h4 { font-size: 0.875rem; font-weight: 600; margin-bottom: 8px; }
        .obs-box.positivo h4 { color: #166534; }
        .obs-box.atencao h4 { color: #854d0e; }
        .obs-box p { font-size: 0.8125rem; line-height: 1.6; }

        .capex-table { width: 100%; border-collapse: collapse; }
        .capex-table th, .capex-table td {
            padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border);
        }
        .capex-table th {
            background: var(--bg); font-size: 0.6875rem; font-weight: 600;
            color: var(--text-light); text-transform: uppercase;
        }
        .capex-table td { font-size: 0.875rem; }
        .capex-table .value { font-weight: 600; color: var(--accent); }

        .laudo-footer {
            background: var(--bg); padding: 20px 40px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.75rem; color: var(--text-light);
        }

        /* FICHA */
        .ficha {
            background: var(--card); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden; max-width: 700px; margin: 0 auto;
        }
        .ficha-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1e293b 100%);
            color: white; padding: 28px; display: flex; justify-content: space-between; align-items: center;
        }
        .ficha-info h1 { font-family: 'Fraunces', serif; font-size: 1.375rem; margin-bottom: 4px; }
        .ficha-info p { opacity: 0.8; font-size: 0.875rem; }
        .ficha-score { text-align: center; }
        .ficha-score .num { font-family: 'Fraunces', serif; font-size: 2.75rem; font-weight: 700; line-height: 1; }
        .ficha-score .label { font-size: 0.625rem; opacity: 0.7; }
        .ficha-score .badge {
            display: inline-block; margin-top: 6px; padding: 4px 12px;
            background: rgba(255,255,255,0.2); border-radius: 100px; font-size: 0.625rem; font-weight: 600;
        }
        .ficha-body { padding: 28px; }
        .ficha-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
        .ficha-stat { text-align: center; padding: 14px; background: var(--bg); border-radius: 10px; }
        .ficha-stat .value { font-size: 1.375rem; font-weight: 700; color: var(--primary); }
        .ficha-stat .label { font-size: 0.6875rem; color: var(--text-light); }
        .ficha-dimensions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .ficha-dim { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 10px; }
        .ficha-dim .icon { font-size: 1.25rem; }
        .ficha-dim .info { flex: 1; }
        .ficha-dim .name { font-size: 0.75rem; color: var(--text-light); }
        .ficha-dim .score { font-size: 1rem; font-weight: 700; }
        .ficha-dim .bar { height: 4px; background: var(--border); border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .ficha-dim .fill { height: 100%; border-radius: 2px; }
        .ficha-indicators { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 24px; }
        .ficha-ind { text-align: center; padding: 12px; border-radius: 8px; }
        .ficha-ind .value { font-size: 0.9375rem; font-weight: 600; }
        .ficha-ind .label { font-size: 0.625rem; color: var(--text-light); }
        .ficha-solar { background: var(--bg); border-radius: 12px; padding: 16px; }
        .ficha-solar h3 { font-size: 0.8125rem; font-weight: 600; margin-bottom: 10px; }
        .solar-mini { display: flex; flex-wrap: wrap; gap: 8px; }
        .solar-mini-item { background: white; padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; }
        .solar-mini-item strong { font-weight: 600; }
        .ficha-footer {
            background: var(--bg); padding: 14px 28px;
            display: flex; justify-content: space-between; font-size: 0.6875rem; color: var(--text-light);
        }

        @media print {
            .control-panel, .tabs-bar, .btn { display: none !important; }
            .content { padding: 0; }
            .laudo, .ficha { box-shadow: none; border-radius: 0; }
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div class="control-header">
            <div class="logo">
                <div class="logo-box">Q</div>
                <span class="logo-text">Qmob</span>
            </div>
            <div class="control-actions">
                <button class="btn btn-outline" onclick="loadDemoData()">üìã Demo</button>
                <button class="btn btn-ai" onclick="openAIModal()">ü§ñ An√°lise IA</button>
                <button class="btn btn-outline" onclick="openConfigModal()">‚öôÔ∏è</button>
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è PDF</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√£o -->
    <div class="modal-overlay" id="configModal">
        <div class="modal">
            <h3>‚öôÔ∏è Configura√ß√µes</h3>
            <p style="font-size: 0.8125rem; color: var(--text-light); margin-bottom: 16px;">Configure sua API Key da Anthropic para usar a an√°lise por IA.</p>
            <label style="font-size: 0.75rem; font-weight: 600; color: var(--text-light);">API Key (Claude)</label>
            <input type="password" class="modal-input" id="apiKeyInput" placeholder="sk-ant-api...">
            <p style="font-size: 0.6875rem; color: var(--text-light);">Sua chave √© salva apenas localmente no seu navegador.</p>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeConfigModal()" style="color: var(--text);">Cancelar</button>
                <button class="btn btn-primary" onclick="saveApiKey()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de An√°lise IA -->
    <div class="modal-overlay" id="aiModal">
        <div class="modal" style="max-width: 600px;">
            <h3>ü§ñ An√°lise por Intelig√™ncia Artificial</h3>
            <div id="aiModalContent">
                <p style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 16px;">A IA ir√° analisar os dados da auditoria e gerar:</p>
                <ul style="font-size: 0.875rem; color: var(--text); margin-left: 20px; margin-bottom: 16px;">
                    <li>Resumo executivo</li>
                    <li>Perfil do comprador ideal</li>
                    <li>Argumentos de venda</li>
                    <li>Red flags identificados</li>
                    <li>Sugest√µes estrat√©gicas</li>
                </ul>
                <div class="modal-actions">
                    <button class="btn btn-outline" onclick="closeAIModal()" style="color: var(--text);">Cancelar</button>
                    <button class="btn btn-ai" onclick="runAIAnalysis()">üöÄ Gerar An√°lise</button>
                </div>
            </div>
            <div id="aiLoading" style="display: none; text-align: center; padding: 40px;">
                <div style="font-size: 2rem; margin-bottom: 10px;">üîÑ</div>
                <p style="color: var(--text-light);">Analisando dados com IA...</p>
            </div>
            <div id="aiResult" style="display: none;">
                <div id="aiResultContent" class="ai-content"></div>
                <div class="modal-actions" style="margin-top: 20px;">
                    <button class="btn btn-outline" onclick="closeAIModal()" style="color: var(--text);">Fechar</button>
                    <button class="btn btn-primary" onclick="insertAIIntoLaudo()">üìÑ Inserir no Laudo</button>
                </div>
            </div>
        </div>
    </div>

    <div class="tabs-bar">
        <div class="tabs-inner">
            <button class="tab-btn active" data-tab="completo">üìÑ Dossi√™ Completo</button>
            <button class="tab-btn" data-tab="ficha">üìä Ficha Visual</button>
        </div>
    </div>

    <div class="content">
        <div class="tab-content active" id="tab-completo">
            <div id="laudo-container"></div>
        </div>
        <div class="tab-content" id="tab-ficha">
            <div id="ficha-container"></div>
        </div>
    </div>

    <script>
        // Tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        function loadData() {
            const saved = localStorage.getItem('qmob_laudo');
            return saved ? JSON.parse(saved) : null;
        }

        function loadDemoData() {
            const demo = {
                form: {
                    endereco: 'Rua Padre Chagas, 300/801',
                    bairro: 'Moinhos de Vento',
                    cep: '90570-080',
                    area: '142',
                    quartos: '3',
                    suites: '1',
                    vagas: '2',
                    andar: '8',
                    anoConstrucao: '1998',
                    valorPedido: '1.450.000',
                    valorCondominio: '1.420',
                    iptu: '8.400',
                    lux: '520',
                    db: '42',
                    qtdElevadores: '2',
                    fabricanteElevador: 'Atlas',
                    anoElevador: '1998',
                    anoModernizacao: '2019',
                    larguraVaga: '2.6',
                    comprimentoVaga: '5.2',
                    capexBasico: '45.000',
                    capexMedio: '120.000',
                    capexCompleto: '280.000',
                    pontosFortes: 'Localiza√ß√£o excepcional na Padre Chagas. Vista permanente para o Parc√£o. Planta funcional com boa setoriza√ß√£o. Pr√©dio bem conservado com portaria 24h.',
                    pontosAtencao: 'Cozinha original precisa de moderniza√ß√£o. Banheiro da su√≠te com revestimentos datados. Aquecimento a g√°s com equipamento antigo.',
                    perfilComprador: 'Casal com filhos que valoriza localiza√ß√£o e n√£o tem pressa para reformar, ou investidor buscando valoriza√ß√£o ap√≥s reforma.',
                    tipoPiso: 'porcelanato'
                },
                ratings: {
                    pavimento: 5, segNoturna: 5, mobilidade: 4, super: 5, farmacias: 5, restaurantes: 5, academias: 4,
                    elevador: 4, segPredio: 5, fachada: 4, areasComuns: 4, garagem: 3, saudeCond: 4,
                    luminosidade: 4, layout: 4, acustica: 4, infra: 3, termico: 4, conectividade: 5,
                    pisos: 3, acabCozinha: 2, acabBanheiros: 3, portasJanelas: 3, pintura: 3
                },
                checks: {
                    portaria24h: true, cftv: true, biometria: true, vagaCoberta: true,
                    fibra: true, bomSinal: true, ventCruzada: true, pontosAr: true,
                    podeIntegrar: true, podeEnvidracar: true
                },
                solar: {
                    sala: 'N', cozinha: 'S', quarto1: 'L', quarto2: 'L', quarto3: 'O', varanda: 'N'
                },
                radios: {
                    perfilProduto: 'atualizacao',
                    marketFit: 'bom',
                    precoAdequado: 'compradorFinal'
                },
                scores: { entorno: 91, edificio: 79, imovel: 78, acabamentos: 56, total: 78 },
                score: 78,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('qmob_laudo', JSON.stringify(demo));
            renderAll();
            alert('‚úÖ Dados de demonstra√ß√£o carregados!');
        }

        function getClassification(score) {
            if (score >= 90) return { text: 'Excepcional', color: '#10b981' };
            if (score >= 80) return { text: 'Muito Bom', color: '#22c55e' };
            if (score >= 70) return { text: 'Bom', color: '#eab308' };
            if (score >= 60) return { text: 'Regular', color: '#f97316' };
            return { text: 'Aten√ß√£o', color: '#ef4444' };
        }

        function getSolarMeaning(dir) {
            const meanings = {
                'N': 'Sol no inverno',
                'NE': 'Sol manh√£/inverno',
                'L': 'Sol da manh√£',
                'SE': 'Sol manh√£/ver√£o',
                'S': 'Pouco sol direto',
                'SO': 'Sol tarde/ver√£o',
                'O': 'Sol da tarde',
                'NO': 'Sol tarde/inverno'
            };
            return meanings[dir] || '';
        }

        function getIndicatorClass(type, value) {
            if (type === 'condM2') {
                if (value < 10) return 'green';
                if (value <= 13) return 'yellow';
                return 'red';
            }
            if (type === 'idade') {
                if (value < 15) return 'green';
                if (value <= 30) return 'yellow';
                return 'red';
            }
            if (type === 'elevador') {
                if (value < 5) return 'green';
                if (value <= 10) return 'yellow';
                return 'red';
            }
            return '';
        }

        function getRadioLabel(group, value) {
            const labels = {
                perfilProduto: {
                    pronto: 'Pronto para morar',
                    atualizacao: 'Precisa atualiza√ß√£o leve',
                    reforma: 'Oportunidade de reforma',
                    renovacao: 'Renova√ß√£o completa'
                },
                marketFit: {
                    perfeito: 'Perfeito',
                    bom: 'Bom',
                    parcial: 'Parcial',
                    desalinhado: 'Desalinhado'
                },
                precoAdequado: {
                    compradorFinal: 'Comprador final',
                    investidor: 'Investidor',
                    nenhum: 'Precisa ajuste'
                }
            };
            return labels[group]?.[value] || value;
        }

        function renderLaudoCompleto(data) {
            const container = document.getElementById('laudo-container');
            if (!data) {
                container.innerHTML = `
                    <div class="no-data">
                        <h2>üìã Nenhum laudo encontrado</h2>
                        <p>Complete uma auditoria no app Qmob ou carregue dados de demonstra√ß√£o.</p>
                        <button class="btn btn-primary" onclick="loadDemoData()">Carregar Demo</button>
                    </div>`;
                return;
            }

            const form = data.form || {};
            const ratings = data.ratings || {};
            const checks = data.checks || {};
            const solar = data.solar || {};
            const radios = data.radios || {};
            const scores = data.scores || {};
            const classification = getClassification(data.score || 0);

            // Calcular indicadores
            const area = parseFloat(form.area) || 0;
            const valor = parseFloat((form.valorPedido || '0').replace(/\./g, '').replace(',', '.')) || 0;
            const cond = parseFloat((form.valorCondominio || '0').replace(/\./g, '').replace(',', '.')) || 0;
            const anoConstrucao = parseInt(form.anoConstrucao) || 0;
            const anoMod = parseInt(form.anoModernizacao) || 0;
            const anoAtual = new Date().getFullYear();

            const precoM2 = area > 0 && valor > 0 ? Math.round(valor / area) : 0;
            const condM2 = area > 0 && cond > 0 ? (cond / area).toFixed(2) : 0;
            const idade = anoConstrucao > 0 ? anoAtual - anoConstrucao : 0;
            const idadeElevador = anoMod > 0 ? anoAtual - anoMod : 0;

            container.innerHTML = `
                <div class="laudo">
                    <div class="laudo-header">
                        <div>
                            <div class="laudo-title">${form.endereco || 'Endere√ßo n√£o informado'}</div>
                            <div class="laudo-subtitle">${form.bairro || ''} ‚Ä¢ Porto Alegre/RS</div>
                            <div class="laudo-meta">Auditoria realizada em ${new Date(data.timestamp).toLocaleDateString('pt-BR')}</div>
                        </div>
                        <div class="score-circle">
                            <span class="number">${data.score || '--'}</span>
                            <span class="label">Score Qmob</span>
                            <span class="badge" style="background: ${classification.color}">${classification.text}</span>
                        </div>
                    </div>

                    <div class="laudo-body">
                        <!-- DADOS B√ÅSICOS -->
                        <div class="laudo-section">
                            <h3 class="section-title">üìã Dados do Im√≥vel</h3>
                            <div class="data-grid">
                                <div class="data-item"><div class="label">√Årea Total</div><div class="value">${form.area || '--'} m¬≤</div></div>
                                <div class="data-item"><div class="label">Quartos</div><div class="value">${form.quartos || '--'} (${form.suites || '0'} su√≠te)</div></div>
                                <div class="data-item"><div class="label">Vagas</div><div class="value">${form.vagas || '--'}</div></div>
                                <div class="data-item"><div class="label">Andar</div><div class="value">${form.andar || '--'}¬∫</div></div>
                                <div class="data-item"><div class="label">Ano Constru√ß√£o</div><div class="value">${form.anoConstrucao || '--'}</div></div>
                                <div class="data-item"><div class="label">Valor Pedido</div><div class="value">R$ ${form.valorPedido || '--'}</div></div>
                            </div>
                        </div>

                        <!-- INDICADORES -->
                        <div class="laudo-section">
                            <h3 class="section-title">üìä Indicadores</h3>
                            <div class="data-grid">
                                <div class="data-item"><div class="label">R$/m¬≤ Im√≥vel</div><div class="value">R$ ${precoM2.toLocaleString('pt-BR')}</div></div>
                                <div class="data-item ${getIndicatorClass('condM2', parseFloat(condM2))}"><div class="label">R$/m¬≤ Condom√≠nio</div><div class="value">R$ ${condM2}</div></div>
                                <div class="data-item ${getIndicatorClass('idade', idade)}"><div class="label">Idade do Pr√©dio</div><div class="value">${idade} anos</div></div>
                                <div class="data-item ${getIndicatorClass('elevador', idadeElevador)}"><div class="label">Moderniza√ß√£o Elevador</div><div class="value">${idadeElevador} anos</div></div>
                            </div>
                        </div>

                        <!-- SCORES POR DIMENS√ÉO -->
                        <div class="laudo-section">
                            <h3 class="section-title">üìà An√°lise por Dimens√£o</h3>
                            <div class="dimension-grid">
                                <div class="dimension-card">
                                    <div class="dimension-header">
                                        <span class="dimension-name">üó∫Ô∏è Entorno (30%)</span>
                                        <span class="dimension-score" style="color: #f59e0b">${scores.entorno || '--'}</span>
                                    </div>
                                    <div class="dimension-bar"><div class="dimension-fill" style="width: ${scores.entorno || 0}%; background: #f59e0b"></div></div>
                                    <div class="dimension-criteria">
                                        <div class="criteria-item"><span class="criteria-name">Seguran√ßa noturna (23%)</span><span class="criteria-value">${ratings.segNoturna || '--'}/5</span></div>
                                        <div class="criteria-item"><span class="criteria-name">Mobilidade (18%)</span><span class="criteria-value">${ratings.mobilidade || '--'}/5</span></div>
                                        <div class="criteria-item"><span class="criteria-name">Supermercados (18%)</span><span class="criteria-value">${ratings.super || '--'}/5</span></div>
                                    </div>
                                </div>
                                <div class="dimension-card">
                                    <div class="dimension-header">
                                        <span class="dimension-name">üè¢ Edif√≠cio (25%)</span>
                                        <span class="dimension-score" style="color: #22c55e">${scores.edificio || '--'}</span>
                                    </div>
                                    <div class="dimension-bar"><div class="dimension-fill" style="width: ${scores.edificio || 0}%; background: #22c55e"></div></div>
                                    <div class="dimension-criteria">
                                        <div class="criteria-item"><span class="criteria-name">Fachada (22.5%)</span><span class="criteria-value">${ratings.fachada || '--'}/5</span></div>
                                        <div class="criteria-item"><span class="criteria-name">√Åreas comuns (22.5%)</span><span class="criteria-value">${ratings.areasComuns || '--'}/5</span></div>
                                        <div class="criteria-item"><span class="criteria-name">Seguran√ßa (20%)</span><span class="criteria-value">${ratings.segPredio || '--'}/5</span></div>
                                    </div>
                                </div>
                                <div class="dimension-card">
                                    <div class="dimension-header">
                                        <span class="dimension-name">üè† Im√≥vel (30%)</span>
                                        <span class="dimension-score" style="color: #3b82f6">${scores.imovel || '--'}</span>
                                    </div>
                                    <div class="dimension-bar"><div class="dimension-fill" style="width: ${scores.imovel || 0}%; background: #3b82f6"></div></div>
                                    <div class="dimension-criteria">
                                        <div class="criteria-item"><span class="criteria-name">Luminosidade (38%)</span><span class="criteria-value">${ratings.luminosidade || '--'}/5</span></div>
                                        <div class="criteria-item"><span class="criteria-name">Layout (37%)</span><span class="criteria-value">${ratings.layout || '--'}/5</span></div>
                                        <div class="criteria-item"><span class="criteria-name">Ac√∫stica (8%)</span><span class="criteria-value">${ratings.acustica || '--'}/5</span></div>
                                    </div>
                                </div>
                                <div class="dimension-card">
                                    <div class="dimension-header">
                                        <span class="dimension-name">üé® Acabamentos (15%)</span>
                                        <span class="dimension-score" style="color: #ec4899">${scores.acabamentos || '--'}</span>
                                    </div>
                                    <div class="dimension-bar"><div class="dimension-fill" style="width: ${scores.acabamentos || 0}%; background: #ec4899"></div></div>
                                    <div class="dimension-criteria">
                                        <div class="criteria-item"><span class="criteria-name">Cozinha (25%)</span><span class="criteria-value">${ratings.acabCozinha || '--'}/5</span></div>
                                        <div class="criteria-item"><span class="criteria-name">Banheiros (25%)</span><span class="criteria-value">${ratings.acabBanheiros || '--'}/5</span></div>
                                        <div class="criteria-item"><span class="criteria-name">Pisos (20%)</span><span class="criteria-value">${ratings.pisos || '--'}/5</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ORIENTA√á√ÉO SOLAR -->
                        ${Object.keys(solar).length > 0 ? `
                        <div class="laudo-section">
                            <h3 class="section-title">üåÖ Orienta√ß√£o Solar</h3>
                            <div class="solar-grid">
                                ${Object.entries(solar).map(([room, dir]) => `
                                    <div class="solar-item">
                                        <div class="room">${room.charAt(0).toUpperCase() + room.slice(1)}</div>
                                        <div class="dir">${dir}</div>
                                        <div class="meaning">${getSolarMeaning(dir)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <!-- DIFERENCIAIS -->
                        <div class="laudo-section">
                            <h3 class="section-title">‚úÖ Diferenciais</h3>
                            <div class="checklist-grid">
                                ${checks.portaria24h ? '<div class="check-display yes">‚úì Portaria 24h</div>' : ''}
                                ${checks.cftv ? '<div class="check-display yes">‚úì CFTV</div>' : ''}
                                ${checks.biometria ? '<div class="check-display yes">‚úì Biometria</div>' : ''}
                                ${checks.fibra ? '<div class="check-display yes">‚úì Fibra √≥ptica</div>' : ''}
                                ${checks.vagaCoberta ? '<div class="check-display yes">‚úì Vaga coberta</div>' : ''}
                                ${checks.ventCruzada ? '<div class="check-display yes">‚úì Ventila√ß√£o cruzada</div>' : ''}
                                ${checks.pontosAr ? '<div class="check-display yes">‚úì Preparado p/ ar</div>' : ''}
                                ${checks.podeIntegrar ? '<div class="check-display yes">‚úì Pode integrar cozinha</div>' : ''}
                                ${checks.podeEnvidracar ? '<div class="check-display yes">‚úì Pode envidra√ßar varanda</div>' : ''}
                            </div>
                        </div>

                        <!-- POSICIONAMENTO -->
                        <div class="laudo-section">
                            <h3 class="section-title">üéØ Posicionamento Estrat√©gico</h3>
                            <div class="positioning-box">
                                <div class="positioning-grid">
                                    <div class="positioning-item">
                                        <div class="label">Perfil do Produto</div>
                                        <div class="value">${getRadioLabel('perfilProduto', radios.perfilProduto)}</div>
                                    </div>
                                    <div class="positioning-item">
                                        <div class="label">Market Fit</div>
                                        <div class="value">${getRadioLabel('marketFit', radios.marketFit)}</div>
                                    </div>
                                    <div class="positioning-item">
                                        <div class="label">Pre√ßo Adequado Para</div>
                                        <div class="value">${getRadioLabel('precoAdequado', radios.precoAdequado)}</div>
                                    </div>
                                </div>
                            </div>
                            ${form.perfilComprador ? `
                            <div style="margin-top: 16px; padding: 16px; background: var(--bg); border-radius: 10px;">
                                <div style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 6px;">Perfil do Comprador Ideal</div>
                                <div style="font-size: 0.875rem;">${form.perfilComprador}</div>
                            </div>
                            ` : ''}
                        </div>

                        <!-- INVESTIMENTO -->
                        <div class="laudo-section">
                            <h3 class="section-title">üí∞ Estimativa de Investimento</h3>
                            <table class="capex-table">
                                <thead><tr><th>Cen√°rio</th><th>Escopo</th><th>Investimento</th></tr></thead>
                                <tbody>
                                    <tr><td>B√°sico</td><td>Pintura e reparos</td><td class="value">R$ ${form.capexBasico || '--'}</td></tr>
                                    <tr><td>M√©dio</td><td>+ Cozinha e banheiros</td><td class="value">R$ ${form.capexMedio || '--'}</td></tr>
                                    <tr><td>Completo</td><td>Reforma total</td><td class="value">R$ ${form.capexCompleto || '--'}</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- OBSERVA√á√ïES -->
                        <div class="laudo-section">
                            <h3 class="section-title">üìù An√°lise Final</h3>
                            <div class="obs-grid">
                                <div class="obs-box positivo">
                                    <h4>‚úÖ Pontos Fortes</h4>
                                    <p>${form.pontosFortes || 'N√£o informado.'}</p>
                                </div>
                                <div class="obs-box atencao">
                                    <h4>‚ö†Ô∏è Pontos de Aten√ß√£o</h4>
                                    <p>${form.pontosAtencao || 'N√£o informado.'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="laudo-footer">
                        <div>Qmob ‚Ä¢ Auditoria Qualitativa de Im√≥veis</div>
                        <div>Documento gerado em ${new Date().toLocaleDateString('pt-BR')}</div>
                    </div>
                </div>
            `;
        }

        function renderFichaVisual(data) {
            const container = document.getElementById('ficha-container');
            if (!data) {
                container.innerHTML = `
                    <div class="no-data">
                        <h2>üìã Nenhum laudo encontrado</h2>
                        <p>Complete uma auditoria no app Qmob ou carregue dados de demonstra√ß√£o.</p>
                        <button class="btn btn-primary" onclick="loadDemoData()">Carregar Demo</button>
                    </div>`;
                return;
            }

            const form = data.form || {};
            const scores = data.scores || {};
            const solar = data.solar || {};
            const classification = getClassification(data.score || 0);

            const area = parseFloat(form.area) || 0;
            const valor = parseFloat((form.valorPedido || '0').replace(/\./g, '').replace(',', '.')) || 0;
            const cond = parseFloat((form.valorCondominio || '0').replace(/\./g, '').replace(',', '.')) || 0;
            const condM2 = area > 0 && cond > 0 ? (cond / area).toFixed(2) : 0;

            container.innerHTML = `
                <div class="ficha">
                    <div class="ficha-header">
                        <div class="ficha-info">
                            <h1>${form.endereco || 'Endere√ßo'}</h1>
                            <p>${form.bairro || ''} ‚Ä¢ Porto Alegre/RS</p>
                        </div>
                        <div class="ficha-score">
                            <div class="num">${data.score || '--'}</div>
                            <div class="label">Score Qmob</div>
                            <span class="badge" style="background: ${classification.color}">${classification.text}</span>
                        </div>
                    </div>

                    <div class="ficha-body">
                        <div class="ficha-stats">
                            <div class="ficha-stat"><div class="value">${form.area || '--'}</div><div class="label">m¬≤</div></div>
                            <div class="ficha-stat"><div class="value">${form.quartos || '--'}</div><div class="label">Quartos</div></div>
                            <div class="ficha-stat"><div class="value">${form.vagas || '--'}</div><div class="label">Vagas</div></div>
                            <div class="ficha-stat"><div class="value">${form.andar || '--'}¬∫</div><div class="label">Andar</div></div>
                        </div>

                        <div class="ficha-dimensions">
                            <div class="ficha-dim">
                                <span class="icon">üó∫Ô∏è</span>
                                <div class="info">
                                    <div class="name">Entorno</div>
                                    <div class="score">${scores.entorno || '--'}/100</div>
                                    <div class="bar"><div class="fill" style="width: ${scores.entorno || 0}%; background: #f59e0b"></div></div>
                                </div>
                            </div>
                            <div class="ficha-dim">
                                <span class="icon">üè¢</span>
                                <div class="info">
                                    <div class="name">Edif√≠cio</div>
                                    <div class="score">${scores.edificio || '--'}/100</div>
                                    <div class="bar"><div class="fill" style="width: ${scores.edificio || 0}%; background: #22c55e"></div></div>
                                </div>
                            </div>
                            <div class="ficha-dim">
                                <span class="icon">üè†</span>
                                <div class="info">
                                    <div class="name">Im√≥vel</div>
                                    <div class="score">${scores.imovel || '--'}/100</div>
                                    <div class="bar"><div class="fill" style="width: ${scores.imovel || 0}%; background: #3b82f6"></div></div>
                                </div>
                            </div>
                            <div class="ficha-dim">
                                <span class="icon">üé®</span>
                                <div class="info">
                                    <div class="name">Acabamentos</div>
                                    <div class="score">${scores.acabamentos || '--'}/100</div>
                                    <div class="bar"><div class="fill" style="width: ${scores.acabamentos || 0}%; background: #ec4899"></div></div>
                                </div>
                            </div>
                        </div>

                        <div class="ficha-indicators">
                            <div class="ficha-ind" style="background: #f0fdf4;"><div class="value" style="color: #166534;">R$ ${form.valorCondominio || '--'}</div><div class="label">Condom√≠nio</div></div>
                            <div class="ficha-ind ${condM2 < 10 ? 'style="background: #dcfce7;"' : condM2 <= 13 ? 'style="background: #fef3c7;"' : 'style="background: #fee2e2;"'}"><div class="value">R$ ${condM2}/m¬≤</div><div class="label">Cond/m¬≤</div></div>
                            <div class="ficha-ind" style="background: #f0f9ff;"><div class="value" style="color: #0369a1;">${form.lux || '--'} lux</div><div class="label">Luminosidade</div></div>
                        </div>

                        ${Object.keys(solar).length > 0 ? `
                        <div class="ficha-solar">
                            <h3>üåÖ Orienta√ß√£o Solar</h3>
                            <div class="solar-mini">
                                ${Object.entries(solar).map(([room, dir]) => `
                                    <div class="solar-mini-item"><strong>${room}:</strong> ${dir}</div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    <div class="ficha-footer">
                        <div>Qmob ‚Ä¢ Auditoria Qualitativa</div>
                        <div>${new Date().toLocaleDateString('pt-BR')}</div>
                    </div>
                </div>
            `;
        }

        function renderAll() {
            const data = loadData();
            renderLaudoCompleto(data);
            renderFichaVisual(data);
        }

        renderAll();

        // ========== CONFIGURA√á√ÉO API ==========
        function openConfigModal() {
            const saved = localStorage.getItem('qmob_api_key') || '';
            document.getElementById('apiKeyInput').value = saved;
            document.getElementById('configModal').classList.add('active');
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('qmob_api_key', key);
                alert('‚úÖ API Key salva com sucesso!');
            } else {
                localStorage.removeItem('qmob_api_key');
            }
            closeConfigModal();
        }

        // ========== AN√ÅLISE IA ==========
        let lastAIAnalysis = null;

        function openAIModal() {
            const apiKey = localStorage.getItem('qmob_api_key');
            if (!apiKey) {
                alert('‚ö†Ô∏è Configure sua API Key primeiro!\n\nClique no bot√£o ‚öôÔ∏è para configurar.');
                openConfigModal();
                return;
            }
            document.getElementById('aiModalContent').style.display = 'block';
            document.getElementById('aiLoading').style.display = 'none';
            document.getElementById('aiResult').style.display = 'none';
            document.getElementById('aiModal').classList.add('active');
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.remove('active');
        }

        async function runAIAnalysis() {
            const apiKey = localStorage.getItem('qmob_api_key');
            const data = loadData();
            
            if (!data) {
                alert('‚ö†Ô∏è Nenhum dado de auditoria encontrado!');
                return;
            }

            document.getElementById('aiModalContent').style.display = 'none';
            document.getElementById('aiLoading').style.display = 'block';

            const form = data.form || {};
            const scores = data.scores || {};
            const checks = data.checks || {};
            const radios = data.radios || {};

            const prompt = `Voc√™ √© um especialista em avalia√ß√£o de im√≥veis de alto padr√£o em Porto Alegre. Analise os dados desta auditoria e forne√ßa uma an√°lise estrat√©gica.

DADOS DO IM√ìVEL:
- Endere√ßo: ${form.endereco || 'N√£o informado'}
- Bairro: ${form.bairro || 'N√£o informado'}
- √Årea: ${form.area || '--'}m¬≤
- Quartos: ${form.quartos || '--'} (${form.suites || '0'} su√≠tes)
- Vagas: ${form.vagas || '--'}
- Andar: ${form.andar || '--'}
- Ano constru√ß√£o: ${form.anoConstrucao || '--'}
- Valor pedido: R$ ${form.valorPedido || '--'}
- Condom√≠nio: R$ ${form.valorCondominio || '--'}

SCORES (0-100):
- Score Total: ${data.score || '--'}
- Entorno: ${scores.entorno || '--'}
- Edif√≠cio: ${scores.edificio || '--'}
- Im√≥vel: ${scores.imovel || '--'}
- Acabamentos: ${scores.acabamentos || '--'}

OBSERVA√á√ïES DO AVALIADOR:
- Pontos fortes: ${form.pontosFortes || 'N√£o informado'}
- Pontos de aten√ß√£o: ${form.pontosAtencao || 'N√£o informado'}
- Perfil comprador sugerido: ${form.perfilComprador || 'N√£o informado'}

PERFIL DO PRODUTO: ${radios.perfilProduto || 'N√£o definido'}
MARKET FIT: ${radios.marketFit || 'N√£o definido'}
PRE√áO ADEQUADO PARA: ${radios.precoAdequado || 'N√£o definido'}

${form.motivoChamadaExtra ? `CHAMADA EXTRA: ${form.motivoChamadaExtra} (R$ ${form.valorChamadaExtra}, ${form.parcelasChamadaExtra} parcelas restantes)` : ''}

Por favor, forne√ßa:

1. **RESUMO EXECUTIVO** (2-3 frases sobre o im√≥vel)

2. **PERFIL DO COMPRADOR IDEAL** (quem deveria comprar este im√≥vel e por qu√™)

3. **TOP 3 ARGUMENTOS DE VENDA** (pontos fortes para destacar)

4. **RED FLAGS** (alertas que o corretor deve estar preparado para responder)

5. **ESTRAT√âGIA SUGERIDA** (como posicionar este im√≥vel no mercado)

Seja direto, pr√°tico e focado em insights acion√°veis para um corretor de im√≥veis.`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Erro na API');
                }

                const result = await response.json();
                const analysisText = result.content[0].text;
                
                // Converter markdown b√°sico para HTML
                lastAIAnalysis = analysisText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^### (.*$)/gm, '<h5>$1</h5>')
                    .replace(/^## (.*$)/gm, '<h5>$1</h5>')
                    .replace(/^# (.*$)/gm, '<h5>$1</h5>')
                    .replace(/^\d+\. \*\*(.*?)\*\*/gm, '<h5>$1</h5>')
                    .replace(/^- (.*$)/gm, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');

                document.getElementById('aiResultContent').innerHTML = '<p>' + lastAIAnalysis + '</p>';
                document.getElementById('aiLoading').style.display = 'none';
                document.getElementById('aiResult').style.display = 'block';

            } catch (error) {
                document.getElementById('aiLoading').style.display = 'none';
                document.getElementById('aiModalContent').style.display = 'block';
                alert('‚ùå Erro na an√°lise: ' + error.message + '\n\nVerifique sua API Key.');
            }
        }

        function insertAIIntoLaudo() {
            if (!lastAIAnalysis) return;
            
            // Adicionar se√ß√£o de IA no laudo
            const laudoBody = document.querySelector('.laudo-body');
            if (laudoBody) {
                const aiSection = document.createElement('div');
                aiSection.className = 'laudo-section ai-analysis';
                aiSection.innerHTML = `
                    <h4>ü§ñ An√°lise por Intelig√™ncia Artificial</h4>
                    <div class="ai-content"><p>${lastAIAnalysis}</p></div>
                `;
                laudoBody.appendChild(aiSection);
            }
            
            closeAIModal();
            alert('‚úÖ An√°lise inserida no laudo!');
        }

        // Fechar modais ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
